# ─── Rate Limiting Zone 정의 (IP 기준) ───────────────────────────────────────
# binary_remote_addr: IP당 7byte, 10MB = 약 80만 IP 추적 가능
limit_req_zone $binary_remote_addr zone=auth:10m     rate=5r/s;
limit_req_zone $binary_remote_addr zone=payment:10m  rate=2r/s;
limit_req_zone $binary_remote_addr zone=search:10m   rate=30r/s;
limit_req_zone $binary_remote_addr zone=general:10m  rate=20r/s;

upstream backend {
    server app_blue:8080;
    # Blue-Green 배포 시 아래 줄로 교체:
    # server app_green:8081;

    keepalive 32;
}

server {
    listen 80;
    server_name _;

    # gzip 압축
    gzip on;
    gzip_types application/json application/xml text/plain text/xml;
    gzip_min_length 1024;

    # 공통 프록시 헤더
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;

    # ─── 인증 API (로그인/회원가입) — 브루트포스 방지 ────────────────────────
    # 5r/s: 초당 5회, burst=10: 순간 최대 10개 큐잉, nodelay: 초과 즉시 429
    location ~* ^/api/v1/(auth|members/signup) {
        limit_req zone=auth burst=10 nodelay;
        limit_req_status 429;
        proxy_pass http://backend;
    }

    # ─── 결제 API — 가장 엄격 ────────────────────────────────────────────────
    location /api/v1/payments/ {
        limit_req zone=payment burst=5 nodelay;
        limit_req_status 429;
        proxy_pass http://backend;
    }

    # ─── 검색 API — 여유 있게 ────────────────────────────────────────────────
    location /api/v1/products/search {
        limit_req zone=search burst=50 nodelay;
        limit_req_status 429;
        proxy_pass http://backend;
    }

    # ─── 일반 API ─────────────────────────────────────────────────────────────
    location /api/ {
        limit_req zone=general burst=40 nodelay;
        limit_req_status 429;
        proxy_pass http://backend;
    }

    # ─── 관리자 API ───────────────────────────────────────────────────────────
    location /admin/ {
        limit_req zone=general burst=20 nodelay;
        limit_req_status 429;
        proxy_pass http://backend;
    }

    # ─── Actuator (헬스체크) ──────────────────────────────────────────────────
    location /actuator/health {
        proxy_pass http://backend;
    }

    # ─── Swagger ──────────────────────────────────────────────────────────────
    location ~ ^/(swagger-ui|v3/api-docs) {
        proxy_pass http://backend;
    }

    location / {
        proxy_pass http://backend;
    }

    # ─── 429 응답 커스텀 메시지 ──────────────────────────────────────────────
    error_page 429 /429.json;
    location = /429.json {
        default_type application/json;
        add_header Content-Type "application/json; charset=utf-8";
        return 429 '{"code":"TOO_MANY_REQUESTS","message":"요청이 너무 많습니다. 잠시 후 다시 시도해주세요."}';
    }
}
